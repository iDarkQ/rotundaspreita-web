generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum OptionLetter {
  A
  B
  C
  D
  E
}

model User {
  id       String @id @default(cuid())
  googleId String @unique
  email    String @unique
  name     String

  admin Boolean @default(false)

  usedFreeTest Boolean @default(false)

  banned    Boolean  @default(false)
  createdAt DateTime @default(now())

  deviceSessions DeviceSession[]
  testResults    TestResult[]

  subscription Subscription?
}

model Subscription {
  id String @id @default(cuid())

  stripeSubId String   @unique
  createdAt   DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
}

model DeviceSession {
  id        String @id @default(cuid())
  ipAddress String
  userAgent String
  jwtToken  String

  lastActive DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TestResult {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  optionId String
  option   Option @relation(fields: [optionId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  studyId   String
  study     Study  @relation(fields: [studyId], references: [id], onDelete: Cascade)
  testRunId String @unique
}

model Study {
  id          String       @id @default(cuid())
  title       String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  questions   Question[]
  testResults TestResult[]
}

model Question {
  id        String   @id @default(cuid())
  content   String
  category  String?
  studyId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  study   Study    @relation(fields: [studyId], references: [id], onDelete: Cascade)
  options Option[] @relation("QuestionOptions")

  testResults TestResult[]
}

model Option {
  id         String       @id @default(cuid())
  content    String
  letter     OptionLetter
  answer     Boolean
  questionId String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  question Question @relation("QuestionOptions", fields: [questionId], references: [id], onDelete: Cascade)

  testResults TestResult[]
}
