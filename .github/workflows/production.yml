name: CI/CD Production Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      deployments: write

    steps:
      - name: Create GitHub Deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: ${{ github.token }}
          environment: production
          ref: ${{ github.sha }}
          environment-url: https://rotundaspreita.com/

      - name: Deploy to Server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          timeout: 300s
          script_stop: true
          script: |
            set -e
            
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            nvm use 22 || nvm use default
            echo "Using node version: $(node -v)"

            cd ${{ secrets.APP_DIR }}

            echo "ğŸ“¦ Pulling latest code..."
            git pull origin main

            echo "ğŸ›  Building Docker image..."
            yarn docker:build

            echo "â›” Stopping running containers..."
            docker compose down || true

            echo "ğŸš€ Starting containers..."
            yarn docker:compose

            echo "âœ… Deployment complete!"

      - name: Update Deployment Status (Success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          state: success
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          environment-url: https://rotundaspreita.com/

      - name: Update Deployment Status (Failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ github.token }}
          state: failure
          deployment-id: ${{ steps.deployment.outputs.deployment_id }}
          
# echo "ğŸš€ Starting deployment..."
# export NVM_DIR="$HOME/.nvm"
# [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
# nvm use 22 || nvm use default
# echo "Using node version: $(node -v)"
# cd ${{ secrets.APP_DIR }}
# echo "ğŸ“¦ Pulling latest code..."
# git pull origin main
# echo "ğŸ“‹ Installing dependencies..."
# npx yarn install
# echo "ğŸ—„ï¸ Running database operations..."
# npx yarn prisma generate
# npx yarn prisma migrate deploy
# echo "ğŸ”¨ Building application..."
# npx yarn build
# cd ${{ secrets.APP_DIR }}
# echo "ğŸ”„ Stopping services..."
# pm2 stop rotundaspreita-web || true
# pm2 delete rotundaspreita-web || true
# echo "ğŸ”„ Starting services..."
# pm2 start ecosystem.config.js --only "rotundaspreita-web"
# pm2 save
# pm2 startup -u $USER --hp $HOME
# echo "âœ… Deployment completed successfully!"
# echo "ğŸ“Š PM2 Status:"
# pm2 status